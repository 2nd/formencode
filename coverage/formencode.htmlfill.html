<html>
<head>
<title>formencode.htmlfill</title>
</head>
<body>
formencode.htmlfill
<style>
.coverage pre {float: left; margin: 0px 1em; border: none;
               padding: 0px; }
.num pre { margin: 0px }
.nocov, .nocov pre {background-color: #faa}
.cov, .cov pre {background-color: #cfc}
div.coverage div { clear: both; height: 1.1em}
</style>
<div class="stats">
Covered: 276 lines<br/>
Missed: 203 lines<br/>
Skipped 54 lines<br/>
Percent: 57 %<br/>

</div>
<div class="coverage">
<div class="cov"><span class="num"><pre>  1</pre></span><pre>&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>  2</pre></span><pre>Parser for HTML forms, that fills in defaults and errors.  See</pre></div>
<div class="cov"><span class="num"><pre>  3</pre></span><pre>``render``.</pre></div>
<div class="cov"><span class="num"><pre>  4</pre></span><pre>&quot;&quot;&quot;</pre></div>
<div class="skip"><span class="num"><pre>  5</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre>  6</pre></span><pre>import HTMLParser</pre></div>
<div class="nocov"><span class="num"><pre>  7</pre></span><pre>import re</pre></div>
<div class="nocov"><span class="num"><pre>  8</pre></span><pre>from formencode.rewritingparser import RewritingParser, html_quote</pre></div>
<div class="skip"><span class="num"><pre>  9</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre> 10</pre></span><pre>__all__ = ['render', 'htmlliteral', 'default_formatter',</pre></div>
<div class="nocov"><span class="num"><pre> 11</pre></span><pre>           'none_formatter', 'escape_formatter',</pre></div>
<div class="nocov"><span class="num"><pre> 12</pre></span><pre>           'FillingParser']</pre></div>
<div class="skip"><span class="num"><pre> 13</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre> 14</pre></span><pre>def render(form, defaults=None, errors=None, use_all_keys=False,</pre></div>
<div class="nocov"><span class="num"><pre> 15</pre></span><pre>           error_formatters=None, add_attributes=None,</pre></div>
<div class="nocov"><span class="num"><pre> 16</pre></span><pre>           auto_insert_errors=True, auto_error_formatter=None,</pre></div>
<div class="nocov"><span class="num"><pre> 17</pre></span><pre>           text_as_default=False, listener=None, encoding=None,</pre></div>
<div class="nocov"><span class="num"><pre> 18</pre></span><pre>           error_class='error', prefix_error=True,</pre></div>
<div class="nocov"><span class="num"><pre> 19</pre></span><pre>           force_defaults=True):</pre></div>
<div class="nocov"><span class="num"><pre> 20</pre></span><pre>    &quot;&quot;&quot;</pre></div>
<div class="nocov"><span class="num"><pre> 21</pre></span><pre>    Render the ``form`` (which should be a string) given the defaults</pre></div>
<div class="nocov"><span class="num"><pre> 22</pre></span><pre>    and errors.  Defaults are the values that go in the input fields</pre></div>
<div class="nocov"><span class="num"><pre> 23</pre></span><pre>    (overwriting any values that are there) and errors are displayed</pre></div>
<div class="nocov"><span class="num"><pre> 24</pre></span><pre>    inline in the form (and also effect input classes).  Returns the</pre></div>
<div class="nocov"><span class="num"><pre> 25</pre></span><pre>    rendered string.</pre></div>
<div class="skip"><span class="num"><pre> 26</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre> 27</pre></span><pre>    If ``auto_insert_errors`` is true (the default) then any errors</pre></div>
<div class="nocov"><span class="num"><pre> 28</pre></span><pre>    for which ``&lt;form:error&gt;`` tags can't be found will be put just</pre></div>
<div class="nocov"><span class="num"><pre> 29</pre></span><pre>    above the associated input field, or at the top of the form if no</pre></div>
<div class="nocov"><span class="num"><pre> 30</pre></span><pre>    field can be found.</pre></div>
<div class="skip"><span class="num"><pre> 31</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre> 32</pre></span><pre>    If ``use_all_keys`` is true, if there are any extra fields from</pre></div>
<div class="nocov"><span class="num"><pre> 33</pre></span><pre>    defaults or errors that couldn't be used in the form it will be an</pre></div>
<div class="nocov"><span class="num"><pre> 34</pre></span><pre>    error.</pre></div>
<div class="skip"><span class="num"><pre> 35</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre> 36</pre></span><pre>    ``error_formatters`` is a dictionary of formatter names to</pre></div>
<div class="nocov"><span class="num"><pre> 37</pre></span><pre>    one-argument functions that format an error into HTML.  Some</pre></div>
<div class="nocov"><span class="num"><pre> 38</pre></span><pre>    default formatters are provided if you don't provide this.</pre></div>
<div class="skip"><span class="num"><pre> 39</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre> 40</pre></span><pre>    ``error_class`` is the class added to input fields when there is</pre></div>
<div class="nocov"><span class="num"><pre> 41</pre></span><pre>    an error for that field.</pre></div>
<div class="skip"><span class="num"><pre> 42</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre> 43</pre></span><pre>    ``add_attributes`` is a dictionary of field names to a dictionary</pre></div>
<div class="nocov"><span class="num"><pre> 44</pre></span><pre>    of attribute name/values.  If the name starts with ``+`` then the</pre></div>
<div class="nocov"><span class="num"><pre> 45</pre></span><pre>    value will be appended to any existing attribute (e.g.,</pre></div>
<div class="nocov"><span class="num"><pre> 46</pre></span><pre>    ``{'+class': ' important'}``).</pre></div>
<div class="skip"><span class="num"><pre> 47</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre> 48</pre></span><pre>    ``auto_error_formatter`` is used to create the HTML that goes</pre></div>
<div class="nocov"><span class="num"><pre> 49</pre></span><pre>    above the fields.  By default it wraps the error message in a span</pre></div>
<div class="nocov"><span class="num"><pre> 50</pre></span><pre>    and adds a ``&lt;br&gt;``.</pre></div>
<div class="skip"><span class="num"><pre> 51</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre> 52</pre></span><pre>    If ``text_as_default`` is true (default false) then ``&lt;input</pre></div>
<div class="nocov"><span class="num"><pre> 53</pre></span><pre>    type=unknown&gt;`` will be treated as text inputs.</pre></div>
<div class="skip"><span class="num"><pre> 54</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre> 55</pre></span><pre>    ``listener`` can be an object that watches fields pass; the only</pre></div>
<div class="nocov"><span class="num"><pre> 56</pre></span><pre>    one currently is in ``htmlfill_schemabuilder.SchemaBuilder``</pre></div>
<div class="skip"><span class="num"><pre> 57</pre></span><pre>    </pre></div>
<div class="nocov"><span class="num"><pre> 58</pre></span><pre>    ``encoding`` specifies an encoding to assume when mixing str and </pre></div>
<div class="nocov"><span class="num"><pre> 59</pre></span><pre>    unicode text in the template.</pre></div>
<div class="skip"><span class="num"><pre> 60</pre></span><pre>    </pre></div>
<div class="nocov"><span class="num"><pre> 61</pre></span><pre>    ``prefix_error`` specifies if the HTML created by auto_error_formatter is</pre></div>
<div class="nocov"><span class="num"><pre> 62</pre></span><pre>    put before the input control (default) or after the control.</pre></div>
<div class="skip"><span class="num"><pre> 63</pre></span><pre>    </pre></div>
<div class="nocov"><span class="num"><pre> 64</pre></span><pre>    ``force_defaults`` specifies if a field default is not given in</pre></div>
<div class="nocov"><span class="num"><pre> 65</pre></span><pre>    the ``defaults`` dictionary then the control associated with the</pre></div>
<div class="nocov"><span class="num"><pre> 66</pre></span><pre>    field should be set as an unsuccessful control. So checkboxes will</pre></div>
<div class="nocov"><span class="num"><pre> 67</pre></span><pre>    be cleared, radio and select controls will have no value selected,</pre></div>
<div class="nocov"><span class="num"><pre> 68</pre></span><pre>    and textareas will be emptied. This defaults to ``True``, which is</pre></div>
<div class="nocov"><span class="num"><pre> 69</pre></span><pre>    appropriate the defaults are the result of a form submission.</pre></div>
<div class="nocov"><span class="num"><pre> 70</pre></span><pre>    &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 71</pre></span><pre>    if defaults is None:</pre></div>
<div class="cov"><span class="num"><pre> 72</pre></span><pre>        defaults = {}</pre></div>
<div class="cov"><span class="num"><pre> 73</pre></span><pre>    if auto_insert_errors and auto_error_formatter is None:</pre></div>
<div class="cov"><span class="num"><pre> 74</pre></span><pre>        auto_error_formatter = default_formatter</pre></div>
<div class="cov"><span class="num"><pre> 75</pre></span><pre>    p = FillingParser(</pre></div>
<div class="cov"><span class="num"><pre> 76</pre></span><pre>        defaults=defaults, errors=errors,</pre></div>
<div class="cov"><span class="num"><pre> 77</pre></span><pre>        use_all_keys=use_all_keys,</pre></div>
<div class="cov"><span class="num"><pre> 78</pre></span><pre>        error_formatters=error_formatters,</pre></div>
<div class="cov"><span class="num"><pre> 79</pre></span><pre>        add_attributes=add_attributes,</pre></div>
<div class="cov"><span class="num"><pre> 80</pre></span><pre>        auto_error_formatter=auto_error_formatter,</pre></div>
<div class="cov"><span class="num"><pre> 81</pre></span><pre>        text_as_default=text_as_default,</pre></div>
<div class="cov"><span class="num"><pre> 82</pre></span><pre>        listener=listener, encoding=encoding,</pre></div>
<div class="cov"><span class="num"><pre> 83</pre></span><pre>        prefix_error=prefix_error,</pre></div>
<div class="cov"><span class="num"><pre> 84</pre></span><pre>        error_class=error_class,</pre></div>
<div class="cov"><span class="num"><pre> 85</pre></span><pre>        force_defaults=force_defaults,</pre></div>
<div class="cov"><span class="num"><pre> 86</pre></span><pre>        )</pre></div>
<div class="cov"><span class="num"><pre> 87</pre></span><pre>    p.feed(form)</pre></div>
<div class="cov"><span class="num"><pre> 88</pre></span><pre>    p.close()</pre></div>
<div class="cov"><span class="num"><pre> 89</pre></span><pre>    return p.text()</pre></div>
<div class="skip"><span class="num"><pre> 90</pre></span><pre>        </pre></div>
<div class="skip"><span class="num"><pre> 91</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre> 92</pre></span><pre>class htmlliteral(object):</pre></div>
<div class="skip"><span class="num"><pre> 93</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre> 94</pre></span><pre>    def __init__(self, html, text=None):</pre></div>
<div class="cov"><span class="num"><pre> 95</pre></span><pre>        if text is None:</pre></div>
<div class="cov"><span class="num"><pre> 96</pre></span><pre>            text = re.sub(r'&lt;.*?&gt;', '', html)</pre></div>
<div class="cov"><span class="num"><pre> 97</pre></span><pre>            text = html.replace('&amp;gt;', '&gt;')</pre></div>
<div class="cov"><span class="num"><pre> 98</pre></span><pre>            text = html.replace('&amp;lt;', '&lt;')</pre></div>
<div class="cov"><span class="num"><pre> 99</pre></span><pre>            text = html.replace('&amp;quot;', '&quot;')</pre></div>
<div class="skip"><span class="num"><pre>100</pre></span><pre>            # @@: Not very complete</pre></div>
<div class="cov"><span class="num"><pre>101</pre></span><pre>        self.html = html</pre></div>
<div class="cov"><span class="num"><pre>102</pre></span><pre>        self.text = text</pre></div>
<div class="skip"><span class="num"><pre>103</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre>104</pre></span><pre>    def __str__(self):</pre></div>
<div class="nocov"><span class="num"><pre>105</pre></span><pre>        return self.text</pre></div>
<div class="skip"><span class="num"><pre>106</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre>107</pre></span><pre>    def __repr__(self):</pre></div>
<div class="nocov"><span class="num"><pre>108</pre></span><pre>        return '&lt;%s html=%r text=%r&gt;' % (</pre></div>
<div class="nocov"><span class="num"><pre>109</pre></span><pre>            self.__class__.__name__, self.html, self.text)</pre></div>
<div class="skip"><span class="num"><pre>110</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre>111</pre></span><pre>    def __html__(self):</pre></div>
<div class="cov"><span class="num"><pre>112</pre></span><pre>        return self.html</pre></div>
<div class="skip"><span class="num"><pre>113</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre>114</pre></span><pre>def default_formatter(error):</pre></div>
<div class="nocov"><span class="num"><pre>115</pre></span><pre>    &quot;&quot;&quot;</pre></div>
<div class="nocov"><span class="num"><pre>116</pre></span><pre>    Formatter that escapes the error, wraps the error in a span with</pre></div>
<div class="nocov"><span class="num"><pre>117</pre></span><pre>    class ``error-message``, and adds a ``&lt;br&gt;``</pre></div>
<div class="nocov"><span class="num"><pre>118</pre></span><pre>    &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>119</pre></span><pre>    return '&lt;span class=&quot;error-message&quot;&gt;%s&lt;/span&gt;&lt;br /&gt;\n' % html_quote(error)</pre></div>
<div class="skip"><span class="num"><pre>120</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre>121</pre></span><pre>def none_formatter(error):</pre></div>
<div class="nocov"><span class="num"><pre>122</pre></span><pre>    &quot;&quot;&quot;</pre></div>
<div class="nocov"><span class="num"><pre>123</pre></span><pre>    Formatter that does nothing, no escaping HTML, nothin'</pre></div>
<div class="nocov"><span class="num"><pre>124</pre></span><pre>    &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>125</pre></span><pre>    return error</pre></div>
<div class="skip"><span class="num"><pre>126</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre>127</pre></span><pre>def escape_formatter(error):</pre></div>
<div class="nocov"><span class="num"><pre>128</pre></span><pre>    &quot;&quot;&quot;</pre></div>
<div class="nocov"><span class="num"><pre>129</pre></span><pre>    Formatter that escapes HTML, no more.</pre></div>
<div class="nocov"><span class="num"><pre>130</pre></span><pre>    &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>131</pre></span><pre>    return html_quote(error)</pre></div>
<div class="skip"><span class="num"><pre>132</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre>133</pre></span><pre>def escapenl_formatter(error):</pre></div>
<div class="nocov"><span class="num"><pre>134</pre></span><pre>    &quot;&quot;&quot;</pre></div>
<div class="nocov"><span class="num"><pre>135</pre></span><pre>    Formatter that escapes HTML, and translates newlines to ``&lt;br&gt;``</pre></div>
<div class="nocov"><span class="num"><pre>136</pre></span><pre>    &quot;&quot;&quot;</pre></div>
<div class="nocov"><span class="num"><pre>137</pre></span><pre>    error = html_quote(error)</pre></div>
<div class="nocov"><span class="num"><pre>138</pre></span><pre>    error = error.replace('\n', '&lt;br&gt;\n')</pre></div>
<div class="nocov"><span class="num"><pre>139</pre></span><pre>    return error</pre></div>
<div class="skip"><span class="num"><pre>140</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre>141</pre></span><pre>def ignore_formatter(error):</pre></div>
<div class="nocov"><span class="num"><pre>142</pre></span><pre>    &quot;&quot;&quot;</pre></div>
<div class="nocov"><span class="num"><pre>143</pre></span><pre>    Formatter that emits nothing, regardless of the error.</pre></div>
<div class="nocov"><span class="num"><pre>144</pre></span><pre>    &quot;&quot;&quot;</pre></div>
<div class="nocov"><span class="num"><pre>145</pre></span><pre>    return ''</pre></div>
<div class="skip"><span class="num"><pre>146</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre>147</pre></span><pre>class FillingParser(RewritingParser):</pre></div>
<div class="nocov"><span class="num"><pre>148</pre></span><pre>    r&quot;&quot;&quot;</pre></div>
<div class="nocov"><span class="num"><pre>149</pre></span><pre>    Fills HTML with default values, as in a form.</pre></div>
<div class="skip"><span class="num"><pre>150</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre>151</pre></span><pre>    Examples::</pre></div>
<div class="skip"><span class="num"><pre>152</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre>153</pre></span><pre>        &gt;&gt;&gt; defaults = {'name': 'Bob Jones',</pre></div>
<div class="nocov"><span class="num"><pre>154</pre></span><pre>        ...             'occupation': 'Crazy Cultist',</pre></div>
<div class="nocov"><span class="num"><pre>155</pre></span><pre>        ...             'address': '14 W. Canal\nNew Guinea',</pre></div>
<div class="nocov"><span class="num"><pre>156</pre></span><pre>        ...             'living': 'no',</pre></div>
<div class="nocov"><span class="num"><pre>157</pre></span><pre>        ...             'nice_guy': 0}</pre></div>
<div class="nocov"><span class="num"><pre>158</pre></span><pre>        &gt;&gt;&gt; parser = FillingParser(defaults)</pre></div>
<div class="nocov"><span class="num"><pre>159</pre></span><pre>        &gt;&gt;&gt; parser.feed('&lt;input type=&quot;text&quot; name=&quot;name&quot; value=&quot;fill&quot;&gt;\</pre></div>
<div class="nocov"><span class="num"><pre>160</pre></span><pre>        ... &lt;select name=&quot;occupation&quot;&gt;&lt;option value=&quot;&quot;&gt;Default&lt;/option&gt;\</pre></div>
<div class="nocov"><span class="num"><pre>161</pre></span><pre>        ... &lt;option value=&quot;Crazy Cultist&quot;&gt;Crazy cultist&lt;/option&gt;\</pre></div>
<div class="nocov"><span class="num"><pre>162</pre></span><pre>        ... &lt;/select&gt; &lt;textarea cols=&quot;20&quot; style=&quot;width: 100%&quot; name=&quot;address&quot;&gt;An address\</pre></div>
<div class="nocov"><span class="num"><pre>163</pre></span><pre>        ... &lt;/textarea&gt; &lt;input type=&quot;radio&quot; name=&quot;living&quot; value=&quot;yes&quot;&gt;\</pre></div>
<div class="nocov"><span class="num"><pre>164</pre></span><pre>        ... &lt;input type=&quot;radio&quot; name=&quot;living&quot; value=&quot;no&quot;&gt;\</pre></div>
<div class="nocov"><span class="num"><pre>165</pre></span><pre>        ... &lt;input type=&quot;checkbox&quot; name=&quot;nice_guy&quot; checked=&quot;checked&quot;&gt;')</pre></div>
<div class="nocov"><span class="num"><pre>166</pre></span><pre>        &gt;&gt;&gt; parser.close()</pre></div>
<div class="nocov"><span class="num"><pre>167</pre></span><pre>        &gt;&gt;&gt; print parser.text() # doctest: +NORMALIZE_WHITESPACE</pre></div>
<div class="nocov"><span class="num"><pre>168</pre></span><pre>        &lt;input type=&quot;text&quot; name=&quot;name&quot; value=&quot;Bob Jones&quot;&gt;</pre></div>
<div class="nocov"><span class="num"><pre>169</pre></span><pre>        &lt;select name=&quot;occupation&quot;&gt;</pre></div>
<div class="nocov"><span class="num"><pre>170</pre></span><pre>        &lt;option value=&quot;&quot;&gt;Default&lt;/option&gt;</pre></div>
<div class="nocov"><span class="num"><pre>171</pre></span><pre>        &lt;option value=&quot;Crazy Cultist&quot; selected=&quot;selected&quot;&gt;Crazy cultist&lt;/option&gt;</pre></div>
<div class="nocov"><span class="num"><pre>172</pre></span><pre>        &lt;/select&gt;</pre></div>
<div class="nocov"><span class="num"><pre>173</pre></span><pre>        &lt;textarea cols=&quot;20&quot; style=&quot;width: 100%&quot; name=&quot;address&quot;&gt;14 W. Canal</pre></div>
<div class="nocov"><span class="num"><pre>174</pre></span><pre>        New Guinea&lt;/textarea&gt;</pre></div>
<div class="nocov"><span class="num"><pre>175</pre></span><pre>        &lt;input type=&quot;radio&quot; name=&quot;living&quot; value=&quot;yes&quot;&gt;</pre></div>
<div class="nocov"><span class="num"><pre>176</pre></span><pre>        &lt;input type=&quot;radio&quot; name=&quot;living&quot; value=&quot;no&quot; checked=&quot;checked&quot;&gt;</pre></div>
<div class="nocov"><span class="num"><pre>177</pre></span><pre>        &lt;input type=&quot;checkbox&quot; name=&quot;nice_guy&quot;&gt;</pre></div>
<div class="skip"><span class="num"><pre>178</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre>179</pre></span><pre>    &quot;&quot;&quot;</pre></div>
<div class="skip"><span class="num"><pre>180</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre>181</pre></span><pre>    default_encoding = 'utf8'</pre></div>
<div class="skip"><span class="num"><pre>182</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre>183</pre></span><pre>    def __init__(self, defaults, errors=None, use_all_keys=False,</pre></div>
<div class="nocov"><span class="num"><pre>184</pre></span><pre>                 error_formatters=None, error_class='error',</pre></div>
<div class="nocov"><span class="num"><pre>185</pre></span><pre>                 add_attributes=None, listener=None,</pre></div>
<div class="nocov"><span class="num"><pre>186</pre></span><pre>                 auto_error_formatter=None,</pre></div>
<div class="nocov"><span class="num"><pre>187</pre></span><pre>                 text_as_default=False, encoding=None, prefix_error=True,</pre></div>
<div class="nocov"><span class="num"><pre>188</pre></span><pre>                 force_defaults=True):</pre></div>
<div class="cov"><span class="num"><pre>189</pre></span><pre>        RewritingParser.__init__(self)</pre></div>
<div class="cov"><span class="num"><pre>190</pre></span><pre>        self.source = None</pre></div>
<div class="cov"><span class="num"><pre>191</pre></span><pre>        self.lines = None</pre></div>
<div class="cov"><span class="num"><pre>192</pre></span><pre>        self.source_pos = None</pre></div>
<div class="cov"><span class="num"><pre>193</pre></span><pre>        self.defaults = defaults</pre></div>
<div class="cov"><span class="num"><pre>194</pre></span><pre>        self.in_textarea = None</pre></div>
<div class="cov"><span class="num"><pre>195</pre></span><pre>        self.skip_textarea = False</pre></div>
<div class="cov"><span class="num"><pre>196</pre></span><pre>        self.last_textarea_name = None</pre></div>
<div class="cov"><span class="num"><pre>197</pre></span><pre>        self.in_select = None</pre></div>
<div class="cov"><span class="num"><pre>198</pre></span><pre>        self.skip_next = False        </pre></div>
<div class="cov"><span class="num"><pre>199</pre></span><pre>        self.errors = errors or {}</pre></div>
<div class="cov"><span class="num"><pre>200</pre></span><pre>        if isinstance(self.errors, (str, unicode)):</pre></div>
<div class="nocov"><span class="num"><pre>201</pre></span><pre>            self.errors = {None: self.errors}</pre></div>
<div class="cov"><span class="num"><pre>202</pre></span><pre>        self.in_error = None</pre></div>
<div class="cov"><span class="num"><pre>203</pre></span><pre>        self.skip_error = False</pre></div>
<div class="cov"><span class="num"><pre>204</pre></span><pre>        self.use_all_keys = use_all_keys</pre></div>
<div class="cov"><span class="num"><pre>205</pre></span><pre>        self.used_keys = {}</pre></div>
<div class="cov"><span class="num"><pre>206</pre></span><pre>        self.used_errors = {}</pre></div>
<div class="cov"><span class="num"><pre>207</pre></span><pre>        if error_formatters is None:</pre></div>
<div class="cov"><span class="num"><pre>208</pre></span><pre>            self.error_formatters = default_formatter_dict</pre></div>
<div class="nocov"><span class="num"><pre>209</pre></span><pre>        else:</pre></div>
<div class="nocov"><span class="num"><pre>210</pre></span><pre>            self.error_formatters = error_formatters</pre></div>
<div class="cov"><span class="num"><pre>211</pre></span><pre>        self.error_class = error_class</pre></div>
<div class="cov"><span class="num"><pre>212</pre></span><pre>        self.add_attributes = add_attributes or {}</pre></div>
<div class="cov"><span class="num"><pre>213</pre></span><pre>        self.listener = listener</pre></div>
<div class="cov"><span class="num"><pre>214</pre></span><pre>        self.auto_error_formatter = auto_error_formatter</pre></div>
<div class="cov"><span class="num"><pre>215</pre></span><pre>        self.text_as_default = text_as_default</pre></div>
<div class="cov"><span class="num"><pre>216</pre></span><pre>        self.encoding = encoding</pre></div>
<div class="cov"><span class="num"><pre>217</pre></span><pre>        self.prefix_error = prefix_error</pre></div>
<div class="cov"><span class="num"><pre>218</pre></span><pre>        self.force_defaults = force_defaults</pre></div>
<div class="skip"><span class="num"><pre>219</pre></span><pre>    </pre></div>
<div class="nocov"><span class="num"><pre>220</pre></span><pre>    def str_compare(self, str1, str2):</pre></div>
<div class="nocov"><span class="num"><pre>221</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="nocov"><span class="num"><pre>222</pre></span><pre>        Compare the two objects as strings (coercing to strings if necessary).</pre></div>
<div class="nocov"><span class="num"><pre>223</pre></span><pre>        Also uses encoding to compare the strings.</pre></div>
<div class="nocov"><span class="num"><pre>224</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>225</pre></span><pre>        if not isinstance(str1, basestring):</pre></div>
<div class="cov"><span class="num"><pre>226</pre></span><pre>            if hasattr(str1, '__unicode__'):</pre></div>
<div class="nocov"><span class="num"><pre>227</pre></span><pre>                str1 = unicode(str1)</pre></div>
<div class="cov"><span class="num"><pre>228</pre></span><pre>            else:</pre></div>
<div class="cov"><span class="num"><pre>229</pre></span><pre>                str1 = str(str1)</pre></div>
<div class="cov"><span class="num"><pre>230</pre></span><pre>        if type(str1) == type(str2):</pre></div>
<div class="cov"><span class="num"><pre>231</pre></span><pre>            return str1 == str2</pre></div>
<div class="cov"><span class="num"><pre>232</pre></span><pre>        if isinstance(str1, unicode):</pre></div>
<div class="nocov"><span class="num"><pre>233</pre></span><pre>            str1 = str1.encode(self.encoding or self.default_encoding)</pre></div>
<div class="cov"><span class="num"><pre>234</pre></span><pre>        else:</pre></div>
<div class="cov"><span class="num"><pre>235</pre></span><pre>            str2 = str2.encode(self.encoding or self.default_encoding)</pre></div>
<div class="cov"><span class="num"><pre>236</pre></span><pre>        return str1 == str2</pre></div>
<div class="skip"><span class="num"><pre>237</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre>238</pre></span><pre>    def close(self):</pre></div>
<div class="cov"><span class="num"><pre>239</pre></span><pre>        self.handle_misc(None)</pre></div>
<div class="cov"><span class="num"><pre>240</pre></span><pre>        RewritingParser.close(self)</pre></div>
<div class="cov"><span class="num"><pre>241</pre></span><pre>        unused_errors = self.errors.copy()</pre></div>
<div class="cov"><span class="num"><pre>242</pre></span><pre>        for key in self.used_errors.keys():</pre></div>
<div class="cov"><span class="num"><pre>243</pre></span><pre>            if unused_errors.has_key(key):</pre></div>
<div class="cov"><span class="num"><pre>244</pre></span><pre>                del unused_errors[key]</pre></div>
<div class="cov"><span class="num"><pre>245</pre></span><pre>        if self.auto_error_formatter:</pre></div>
<div class="cov"><span class="num"><pre>246</pre></span><pre>            for key, value in unused_errors.items():</pre></div>
<div class="cov"><span class="num"><pre>247</pre></span><pre>                error_message = self.auto_error_formatter(value)</pre></div>
<div class="cov"><span class="num"><pre>248</pre></span><pre>                error_message = '&lt;!-- for: %s --&gt;\n%s' % (key, error_message)</pre></div>
<div class="cov"><span class="num"><pre>249</pre></span><pre>                self.insert_at_marker(</pre></div>
<div class="cov"><span class="num"><pre>250</pre></span><pre>                    key, error_message)</pre></div>
<div class="cov"><span class="num"><pre>251</pre></span><pre>            unused_errors = {}</pre></div>
<div class="cov"><span class="num"><pre>252</pre></span><pre>        if self.use_all_keys:</pre></div>
<div class="nocov"><span class="num"><pre>253</pre></span><pre>            unused = self.defaults.copy()</pre></div>
<div class="nocov"><span class="num"><pre>254</pre></span><pre>            for key in self.used_keys.keys():</pre></div>
<div class="nocov"><span class="num"><pre>255</pre></span><pre>                if unused.has_key(key):</pre></div>
<div class="nocov"><span class="num"><pre>256</pre></span><pre>                    del unused[key]</pre></div>
<div class="nocov"><span class="num"><pre>257</pre></span><pre>            assert not unused, (</pre></div>
<div class="nocov"><span class="num"><pre>258</pre></span><pre>                &quot;These keys from defaults were not used in the form: %s&quot;</pre></div>
<div class="nocov"><span class="num"><pre>259</pre></span><pre>                % unused.keys())</pre></div>
<div class="nocov"><span class="num"><pre>260</pre></span><pre>            if unused_errors:</pre></div>
<div class="nocov"><span class="num"><pre>261</pre></span><pre>                error_text = []</pre></div>
<div class="nocov"><span class="num"><pre>262</pre></span><pre>                for key in unused_errors.keys():</pre></div>
<div class="nocov"><span class="num"><pre>263</pre></span><pre>                    error_text.append(&quot;%s: %s&quot; % (key, self.errors[key]))</pre></div>
<div class="nocov"><span class="num"><pre>264</pre></span><pre>                assert False, (</pre></div>
<div class="nocov"><span class="num"><pre>265</pre></span><pre>                    &quot;These errors were not used in the form: %s&quot; % </pre></div>
<div class="nocov"><span class="num"><pre>266</pre></span><pre>                    ', '.join(error_text))</pre></div>
<div class="cov"><span class="num"><pre>267</pre></span><pre>        if self.encoding is not None:</pre></div>
<div class="nocov"><span class="num"><pre>268</pre></span><pre>            new_content = []</pre></div>
<div class="nocov"><span class="num"><pre>269</pre></span><pre>            for item in self._content:</pre></div>
<div class="nocov"><span class="num"><pre>270</pre></span><pre>                if isinstance(item, str):</pre></div>
<div class="nocov"><span class="num"><pre>271</pre></span><pre>                    item = item.decode(self.encoding)</pre></div>
<div class="nocov"><span class="num"><pre>272</pre></span><pre>                new_content.append(item)</pre></div>
<div class="nocov"><span class="num"><pre>273</pre></span><pre>            self._content = new_content</pre></div>
<div class="cov"><span class="num"><pre>274</pre></span><pre>        self._text = self._get_text()</pre></div>
<div class="skip"><span class="num"><pre>275</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre>276</pre></span><pre>    def skip_output(self):</pre></div>
<div class="cov"><span class="num"><pre>277</pre></span><pre>        return (self.in_textarea and self.skip_textarea) or self.skip_error</pre></div>
<div class="skip"><span class="num"><pre>278</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre>279</pre></span><pre>    def add_key(self, key):</pre></div>
<div class="cov"><span class="num"><pre>280</pre></span><pre>        self.used_keys[key] = 1</pre></div>
<div class="skip"><span class="num"><pre>281</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre>282</pre></span><pre>    def handle_starttag(self, tag, attrs, startend=False):</pre></div>
<div class="cov"><span class="num"><pre>283</pre></span><pre>        self.write_pos()</pre></div>
<div class="cov"><span class="num"><pre>284</pre></span><pre>        if tag == 'input':</pre></div>
<div class="cov"><span class="num"><pre>285</pre></span><pre>            self.handle_input(attrs, startend)</pre></div>
<div class="cov"><span class="num"><pre>286</pre></span><pre>        elif tag == 'textarea':</pre></div>
<div class="cov"><span class="num"><pre>287</pre></span><pre>            self.handle_textarea(attrs)</pre></div>
<div class="cov"><span class="num"><pre>288</pre></span><pre>        elif tag == 'select':</pre></div>
<div class="cov"><span class="num"><pre>289</pre></span><pre>            self.handle_select(attrs)</pre></div>
<div class="cov"><span class="num"><pre>290</pre></span><pre>        elif tag == 'option':</pre></div>
<div class="cov"><span class="num"><pre>291</pre></span><pre>            self.handle_option(attrs)</pre></div>
<div class="cov"><span class="num"><pre>292</pre></span><pre>            return</pre></div>
<div class="cov"><span class="num"><pre>293</pre></span><pre>        elif tag == 'form:error':</pre></div>
<div class="cov"><span class="num"><pre>294</pre></span><pre>            self.handle_error(attrs)</pre></div>
<div class="cov"><span class="num"><pre>295</pre></span><pre>            return</pre></div>
<div class="cov"><span class="num"><pre>296</pre></span><pre>        elif tag == 'form:iferror':</pre></div>
<div class="cov"><span class="num"><pre>297</pre></span><pre>            self.handle_iferror(attrs)</pre></div>
<div class="cov"><span class="num"><pre>298</pre></span><pre>            return</pre></div>
<div class="cov"><span class="num"><pre>299</pre></span><pre>        else:</pre></div>
<div class="cov"><span class="num"><pre>300</pre></span><pre>            return</pre></div>
<div class="cov"><span class="num"><pre>301</pre></span><pre>        if self.listener:</pre></div>
<div class="cov"><span class="num"><pre>302</pre></span><pre>            self.listener.listen_input(self, tag, attrs)</pre></div>
<div class="skip"><span class="num"><pre>303</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre>304</pre></span><pre>    def handle_endtag(self, tag):</pre></div>
<div class="cov"><span class="num"><pre>305</pre></span><pre>        self.write_pos()</pre></div>
<div class="cov"><span class="num"><pre>306</pre></span><pre>        if tag == 'textarea':</pre></div>
<div class="cov"><span class="num"><pre>307</pre></span><pre>            self.handle_end_textarea()</pre></div>
<div class="cov"><span class="num"><pre>308</pre></span><pre>        elif tag == 'select':</pre></div>
<div class="cov"><span class="num"><pre>309</pre></span><pre>            self.handle_end_select()</pre></div>
<div class="cov"><span class="num"><pre>310</pre></span><pre>        elif tag == 'form:iferror':</pre></div>
<div class="cov"><span class="num"><pre>311</pre></span><pre>            self.handle_end_iferror()</pre></div>
<div class="skip"><span class="num"><pre>312</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre>313</pre></span><pre>    def handle_startendtag(self, tag, attrs):</pre></div>
<div class="cov"><span class="num"><pre>314</pre></span><pre>        return self.handle_starttag(tag, attrs, True)</pre></div>
<div class="skip"><span class="num"><pre>315</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre>316</pre></span><pre>    def handle_iferror(self, attrs):</pre></div>
<div class="cov"><span class="num"><pre>317</pre></span><pre>        name = self.get_attr(attrs, 'name')</pre></div>
<div class="cov"><span class="num"><pre>318</pre></span><pre>        notted = False</pre></div>
<div class="cov"><span class="num"><pre>319</pre></span><pre>        if name.startswith('not '):</pre></div>
<div class="cov"><span class="num"><pre>320</pre></span><pre>            notted = True</pre></div>
<div class="cov"><span class="num"><pre>321</pre></span><pre>            name = name.split(None, 1)[1]</pre></div>
<div class="cov"><span class="num"><pre>322</pre></span><pre>        assert name, &quot;Name attribute in &lt;iferror&gt; required (%s)&quot; % self.getpos()</pre></div>
<div class="cov"><span class="num"><pre>323</pre></span><pre>        self.in_error = name</pre></div>
<div class="cov"><span class="num"><pre>324</pre></span><pre>        ok = self.errors.get(name)</pre></div>
<div class="cov"><span class="num"><pre>325</pre></span><pre>        if notted:</pre></div>
<div class="cov"><span class="num"><pre>326</pre></span><pre>            ok = not ok</pre></div>
<div class="cov"><span class="num"><pre>327</pre></span><pre>        if not ok:</pre></div>
<div class="cov"><span class="num"><pre>328</pre></span><pre>            self.skip_error = True</pre></div>
<div class="cov"><span class="num"><pre>329</pre></span><pre>        self.skip_next = True</pre></div>
<div class="skip"><span class="num"><pre>330</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre>331</pre></span><pre>    def handle_end_iferror(self):</pre></div>
<div class="cov"><span class="num"><pre>332</pre></span><pre>        self.in_error = None</pre></div>
<div class="cov"><span class="num"><pre>333</pre></span><pre>        self.skip_error = False</pre></div>
<div class="cov"><span class="num"><pre>334</pre></span><pre>        self.skip_next = True</pre></div>
<div class="skip"><span class="num"><pre>335</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre>336</pre></span><pre>    def handle_error(self, attrs):</pre></div>
<div class="cov"><span class="num"><pre>337</pre></span><pre>        name = self.get_attr(attrs, 'name')</pre></div>
<div class="cov"><span class="num"><pre>338</pre></span><pre>        formatter = self.get_attr(attrs, 'format') or 'default'</pre></div>
<div class="cov"><span class="num"><pre>339</pre></span><pre>        if name is None:</pre></div>
<div class="cov"><span class="num"><pre>340</pre></span><pre>            name = self.in_error</pre></div>
<div class="cov"><span class="num"><pre>341</pre></span><pre>        assert name is not None, (</pre></div>
<div class="cov"><span class="num"><pre>342</pre></span><pre>            &quot;Name attribute in &lt;form:error&gt; required if not contained in &quot;</pre></div>
<div class="cov"><span class="num"><pre>343</pre></span><pre>            &quot;&lt;form:iferror&gt; (%i:%i)&quot; % self.getpos())</pre></div>
<div class="cov"><span class="num"><pre>344</pre></span><pre>        error = self.errors.get(name, '')</pre></div>
<div class="cov"><span class="num"><pre>345</pre></span><pre>        if error:</pre></div>
<div class="cov"><span class="num"><pre>346</pre></span><pre>            error = self.error_formatters[formatter](error)</pre></div>
<div class="cov"><span class="num"><pre>347</pre></span><pre>            self.write_text(error)</pre></div>
<div class="cov"><span class="num"><pre>348</pre></span><pre>        self.skip_next = True</pre></div>
<div class="cov"><span class="num"><pre>349</pre></span><pre>        self.used_errors[name] = 1</pre></div>
<div class="skip"><span class="num"><pre>350</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre>351</pre></span><pre>    def handle_input(self, attrs, startend):</pre></div>
<div class="cov"><span class="num"><pre>352</pre></span><pre>        t = (self.get_attr(attrs, 'type') or 'text').lower()</pre></div>
<div class="cov"><span class="num"><pre>353</pre></span><pre>        name = self.get_attr(attrs, 'name')</pre></div>
<div class="cov"><span class="num"><pre>354</pre></span><pre>        if self.prefix_error:</pre></div>
<div class="cov"><span class="num"><pre>355</pre></span><pre>            self.write_marker(name)</pre></div>
<div class="cov"><span class="num"><pre>356</pre></span><pre>        value = self.defaults.get(name)</pre></div>
<div class="cov"><span class="num"><pre>357</pre></span><pre>        if self.add_attributes.has_key(name):</pre></div>
<div class="nocov"><span class="num"><pre>358</pre></span><pre>            for attr_name, attr_value in self.add_attributes[name].items():</pre></div>
<div class="nocov"><span class="num"><pre>359</pre></span><pre>                if attr_name.startswith('+'):</pre></div>
<div class="nocov"><span class="num"><pre>360</pre></span><pre>                    attr_name = attr_name[1:]</pre></div>
<div class="nocov"><span class="num"><pre>361</pre></span><pre>                    self.set_attr(attrs, attr_name,</pre></div>
<div class="nocov"><span class="num"><pre>362</pre></span><pre>                                  self.get_attr(attrs, attr_name, '')</pre></div>
<div class="nocov"><span class="num"><pre>363</pre></span><pre>                                  + attr_value)</pre></div>
<div class="nocov"><span class="num"><pre>364</pre></span><pre>                else:</pre></div>
<div class="nocov"><span class="num"><pre>365</pre></span><pre>                    self.set_attr(attrs, attr_name, attr_value)</pre></div>
<div class="cov"><span class="num"><pre>366</pre></span><pre>        if (self.error_class</pre></div>
<div class="cov"><span class="num"><pre>367</pre></span><pre>            and self.errors.get(self.get_attr(attrs, 'name'))):</pre></div>
<div class="cov"><span class="num"><pre>368</pre></span><pre>            self.add_class(attrs, self.error_class)</pre></div>
<div class="cov"><span class="num"><pre>369</pre></span><pre>        if t in ('text', 'hidden'):</pre></div>
<div class="cov"><span class="num"><pre>370</pre></span><pre>            if value is None and not self.force_defaults:</pre></div>
<div class="cov"><span class="num"><pre>371</pre></span><pre>                value = self.get_attr(attrs, 'value', '')</pre></div>
<div class="cov"><span class="num"><pre>372</pre></span><pre>            self.set_attr(attrs, 'value', value)</pre></div>
<div class="cov"><span class="num"><pre>373</pre></span><pre>            self.write_tag('input', attrs, startend)</pre></div>
<div class="cov"><span class="num"><pre>374</pre></span><pre>            self.skip_next = True</pre></div>
<div class="cov"><span class="num"><pre>375</pre></span><pre>            self.add_key(name)</pre></div>
<div class="cov"><span class="num"><pre>376</pre></span><pre>        elif t == 'checkbox':</pre></div>
<div class="cov"><span class="num"><pre>377</pre></span><pre>            if self.force_defaults:</pre></div>
<div class="cov"><span class="num"><pre>378</pre></span><pre>                selected = False</pre></div>
<div class="cov"><span class="num"><pre>379</pre></span><pre>            else:</pre></div>
<div class="cov"><span class="num"><pre>380</pre></span><pre>                selected = self.get_attr(attrs, 'checked')</pre></div>
<div class="cov"><span class="num"><pre>381</pre></span><pre>            if not self.get_attr(attrs, 'value'):</pre></div>
<div class="cov"><span class="num"><pre>382</pre></span><pre>                selected = value</pre></div>
<div class="cov"><span class="num"><pre>383</pre></span><pre>            elif self.selected_multiple(value,</pre></div>
<div class="cov"><span class="num"><pre>384</pre></span><pre>                                        self.get_attr(attrs, 'value', '')):</pre></div>
<div class="cov"><span class="num"><pre>385</pre></span><pre>                selected = True</pre></div>
<div class="cov"><span class="num"><pre>386</pre></span><pre>            if selected:</pre></div>
<div class="cov"><span class="num"><pre>387</pre></span><pre>                self.set_attr(attrs, 'checked', 'checked')</pre></div>
<div class="cov"><span class="num"><pre>388</pre></span><pre>            else:</pre></div>
<div class="cov"><span class="num"><pre>389</pre></span><pre>                self.del_attr(attrs, 'checked')</pre></div>
<div class="cov"><span class="num"><pre>390</pre></span><pre>            self.write_tag('input', attrs, startend)</pre></div>
<div class="cov"><span class="num"><pre>391</pre></span><pre>            self.skip_next = True</pre></div>
<div class="cov"><span class="num"><pre>392</pre></span><pre>            self.add_key(name)</pre></div>
<div class="cov"><span class="num"><pre>393</pre></span><pre>        elif t == 'radio':</pre></div>
<div class="cov"><span class="num"><pre>394</pre></span><pre>            if self.str_compare(value, self.get_attr(attrs, 'value', '')):</pre></div>
<div class="cov"><span class="num"><pre>395</pre></span><pre>                self.set_attr(attrs, 'checked', 'checked')</pre></div>
<div class="cov"><span class="num"><pre>396</pre></span><pre>            elif self.force_defaults or name in self.defaults:</pre></div>
<div class="cov"><span class="num"><pre>397</pre></span><pre>                self.del_attr(attrs, 'checked')</pre></div>
<div class="cov"><span class="num"><pre>398</pre></span><pre>            self.write_tag('input', attrs, startend)</pre></div>
<div class="cov"><span class="num"><pre>399</pre></span><pre>            self.skip_next = True</pre></div>
<div class="cov"><span class="num"><pre>400</pre></span><pre>            self.add_key(name)</pre></div>
<div class="cov"><span class="num"><pre>401</pre></span><pre>        elif t == 'file':</pre></div>
<div class="nocov"><span class="num"><pre>402</pre></span><pre>            pass # don't skip next</pre></div>
<div class="cov"><span class="num"><pre>403</pre></span><pre>        elif t == 'password':</pre></div>
<div class="cov"><span class="num"><pre>404</pre></span><pre>            if value is None and not self.force_defaults:</pre></div>
<div class="cov"><span class="num"><pre>405</pre></span><pre>                value = value or self.get_attr(attrs, 'value', '')</pre></div>
<div class="cov"><span class="num"><pre>406</pre></span><pre>            self.set_attr(attrs, 'value', value)</pre></div>
<div class="cov"><span class="num"><pre>407</pre></span><pre>            self.write_tag('input', attrs, startend)</pre></div>
<div class="cov"><span class="num"><pre>408</pre></span><pre>            self.skip_next = True</pre></div>
<div class="cov"><span class="num"><pre>409</pre></span><pre>            self.add_key(name)</pre></div>
<div class="cov"><span class="num"><pre>410</pre></span><pre>        elif t == 'image':</pre></div>
<div class="cov"><span class="num"><pre>411</pre></span><pre>            self.write_tag('input', attrs, startend)</pre></div>
<div class="cov"><span class="num"><pre>412</pre></span><pre>            self.skip_next = True</pre></div>
<div class="cov"><span class="num"><pre>413</pre></span><pre>            self.add_key(name)</pre></div>
<div class="cov"><span class="num"><pre>414</pre></span><pre>        elif t == 'submit' or t == 'reset' or t == 'button':</pre></div>
<div class="cov"><span class="num"><pre>415</pre></span><pre>            self.set_attr(attrs, 'value', value or</pre></div>
<div class="cov"><span class="num"><pre>416</pre></span><pre>                          self.get_attr(attrs, 'value', ''))</pre></div>
<div class="cov"><span class="num"><pre>417</pre></span><pre>            self.write_tag('input', attrs, startend)</pre></div>
<div class="cov"><span class="num"><pre>418</pre></span><pre>            self.skip_next = True</pre></div>
<div class="cov"><span class="num"><pre>419</pre></span><pre>            self.add_key(name)</pre></div>
<div class="nocov"><span class="num"><pre>420</pre></span><pre>        elif self.text_as_default:</pre></div>
<div class="nocov"><span class="num"><pre>421</pre></span><pre>            if value is None:</pre></div>
<div class="nocov"><span class="num"><pre>422</pre></span><pre>                value = self.get_attr(attrs, 'value', '')</pre></div>
<div class="nocov"><span class="num"><pre>423</pre></span><pre>            self.set_attr(attrs, 'value', value)</pre></div>
<div class="nocov"><span class="num"><pre>424</pre></span><pre>            self.write_tag('input', attrs, startend)</pre></div>
<div class="nocov"><span class="num"><pre>425</pre></span><pre>            self.skip_next = True</pre></div>
<div class="nocov"><span class="num"><pre>426</pre></span><pre>            self.add_key(name)</pre></div>
<div class="nocov"><span class="num"><pre>427</pre></span><pre>        else:</pre></div>
<div class="nocov"><span class="num"><pre>428</pre></span><pre>            assert 0, &quot;I don't know about this kind of &lt;input&gt;: %s (pos: %s)&quot; \</pre></div>
<div class="nocov"><span class="num"><pre>429</pre></span><pre>                   % (t, self.getpos())</pre></div>
<div class="cov"><span class="num"><pre>430</pre></span><pre>        if not self.prefix_error:</pre></div>
<div class="cov"><span class="num"><pre>431</pre></span><pre>            self.write_marker(name)</pre></div>
<div class="skip"><span class="num"><pre>432</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre>433</pre></span><pre>    def handle_textarea(self, attrs):</pre></div>
<div class="cov"><span class="num"><pre>434</pre></span><pre>        name = self.get_attr(attrs, 'name')</pre></div>
<div class="cov"><span class="num"><pre>435</pre></span><pre>        if self.prefix_error:</pre></div>
<div class="cov"><span class="num"><pre>436</pre></span><pre>            self.write_marker(name)</pre></div>
<div class="cov"><span class="num"><pre>437</pre></span><pre>        if (self.error_class</pre></div>
<div class="cov"><span class="num"><pre>438</pre></span><pre>            and self.errors.get(name)):</pre></div>
<div class="cov"><span class="num"><pre>439</pre></span><pre>            self.add_class(attrs, self.error_class)</pre></div>
<div class="cov"><span class="num"><pre>440</pre></span><pre>        value = self.defaults.get(name, '')</pre></div>
<div class="cov"><span class="num"><pre>441</pre></span><pre>        if value or self.force_defaults:</pre></div>
<div class="cov"><span class="num"><pre>442</pre></span><pre>            self.write_tag('textarea', attrs)</pre></div>
<div class="cov"><span class="num"><pre>443</pre></span><pre>            self.write_text(html_quote(value))</pre></div>
<div class="cov"><span class="num"><pre>444</pre></span><pre>            self.write_text('&lt;/textarea&gt;')</pre></div>
<div class="cov"><span class="num"><pre>445</pre></span><pre>            self.skip_textarea = True</pre></div>
<div class="cov"><span class="num"><pre>446</pre></span><pre>        self.in_textarea = True</pre></div>
<div class="cov"><span class="num"><pre>447</pre></span><pre>        self.last_textarea_name = name</pre></div>
<div class="cov"><span class="num"><pre>448</pre></span><pre>        self.add_key(name)</pre></div>
<div class="skip"><span class="num"><pre>449</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre>450</pre></span><pre>    def handle_end_textarea(self):</pre></div>
<div class="cov"><span class="num"><pre>451</pre></span><pre>        if self.skip_textarea:</pre></div>
<div class="cov"><span class="num"><pre>452</pre></span><pre>            self.skip_textarea = False</pre></div>
<div class="cov"><span class="num"><pre>453</pre></span><pre>        else:</pre></div>
<div class="cov"><span class="num"><pre>454</pre></span><pre>            self.write_text('&lt;/textarea&gt;')            </pre></div>
<div class="cov"><span class="num"><pre>455</pre></span><pre>        self.in_textarea = False</pre></div>
<div class="cov"><span class="num"><pre>456</pre></span><pre>        self.skip_next = True</pre></div>
<div class="cov"><span class="num"><pre>457</pre></span><pre>        if not self.prefix_error:</pre></div>
<div class="cov"><span class="num"><pre>458</pre></span><pre>            self.write_marker(self.last_textarea_name)</pre></div>
<div class="cov"><span class="num"><pre>459</pre></span><pre>        self.last_textarea_name = None</pre></div>
<div class="skip"><span class="num"><pre>460</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre>461</pre></span><pre>    def handle_select(self, attrs):</pre></div>
<div class="cov"><span class="num"><pre>462</pre></span><pre>        name = self.get_attr(attrs, 'name', False)</pre></div>
<div class="cov"><span class="num"><pre>463</pre></span><pre>        if name and self.prefix_error:</pre></div>
<div class="cov"><span class="num"><pre>464</pre></span><pre>            self.write_marker(name)</pre></div>
<div class="cov"><span class="num"><pre>465</pre></span><pre>        if (self.error_class</pre></div>
<div class="cov"><span class="num"><pre>466</pre></span><pre>            and self.errors.get(name)):</pre></div>
<div class="cov"><span class="num"><pre>467</pre></span><pre>            self.add_class(attrs, self.error_class)</pre></div>
<div class="cov"><span class="num"><pre>468</pre></span><pre>        self.in_select = self.get_attr(attrs, 'name', False)</pre></div>
<div class="cov"><span class="num"><pre>469</pre></span><pre>        self.write_tag('select', attrs)</pre></div>
<div class="cov"><span class="num"><pre>470</pre></span><pre>        self.skip_next = True</pre></div>
<div class="cov"><span class="num"><pre>471</pre></span><pre>        self.add_key(self.in_select)</pre></div>
<div class="skip"><span class="num"><pre>472</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre>473</pre></span><pre>    def handle_end_select(self):</pre></div>
<div class="cov"><span class="num"><pre>474</pre></span><pre>        self.write_text('&lt;/select&gt;')</pre></div>
<div class="cov"><span class="num"><pre>475</pre></span><pre>        self.skip_next = True</pre></div>
<div class="cov"><span class="num"><pre>476</pre></span><pre>        if not self.prefix_error and self.in_select:</pre></div>
<div class="cov"><span class="num"><pre>477</pre></span><pre>            self.write_marker(self.in_select)</pre></div>
<div class="cov"><span class="num"><pre>478</pre></span><pre>        self.in_select = None</pre></div>
<div class="skip"><span class="num"><pre>479</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre>480</pre></span><pre>    def handle_option(self, attrs):</pre></div>
<div class="cov"><span class="num"><pre>481</pre></span><pre>        assert self.in_select is not None, (</pre></div>
<div class="cov"><span class="num"><pre>482</pre></span><pre>            &quot;&lt;option&gt; outside of &lt;select&gt;: line %i, column %i&quot;</pre></div>
<div class="cov"><span class="num"><pre>483</pre></span><pre>            % self.getpos())</pre></div>
<div class="cov"><span class="num"><pre>484</pre></span><pre>        if self.in_select != False:</pre></div>
<div class="cov"><span class="num"><pre>485</pre></span><pre>            default = self.defaults.get(self.in_select, '')</pre></div>
<div class="cov"><span class="num"><pre>486</pre></span><pre>            if self.force_defaults or (self.in_select in self.defaults):</pre></div>
<div class="cov"><span class="num"><pre>487</pre></span><pre>                if self.selected_multiple(self.defaults.get(self.in_select, ''),</pre></div>
<div class="cov"><span class="num"><pre>488</pre></span><pre>                                          self.get_attr(attrs, 'value', '')):</pre></div>
<div class="cov"><span class="num"><pre>489</pre></span><pre>                    self.set_attr(attrs, 'selected', 'selected')</pre></div>
<div class="cov"><span class="num"><pre>490</pre></span><pre>                    self.add_key(self.in_select)</pre></div>
<div class="cov"><span class="num"><pre>491</pre></span><pre>                else:</pre></div>
<div class="cov"><span class="num"><pre>492</pre></span><pre>                    self.del_attr(attrs, 'selected')</pre></div>
<div class="cov"><span class="num"><pre>493</pre></span><pre>        self.write_tag('option', attrs)</pre></div>
<div class="cov"><span class="num"><pre>494</pre></span><pre>        self.skip_next = True</pre></div>
<div class="skip"><span class="num"><pre>495</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre>496</pre></span><pre>    def selected_multiple(self, obj, value):</pre></div>
<div class="nocov"><span class="num"><pre>497</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="nocov"><span class="num"><pre>498</pre></span><pre>        Returns true/false if obj indicates that value should be</pre></div>
<div class="nocov"><span class="num"><pre>499</pre></span><pre>        selected.  If obj has a __contains__ method it is used, otherwise</pre></div>
<div class="nocov"><span class="num"><pre>500</pre></span><pre>        identity is used.</pre></div>
<div class="nocov"><span class="num"><pre>501</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>502</pre></span><pre>        if obj is None:</pre></div>
<div class="cov"><span class="num"><pre>503</pre></span><pre>            return value == &quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>504</pre></span><pre>        if isinstance(obj, (str, unicode)):</pre></div>
<div class="cov"><span class="num"><pre>505</pre></span><pre>            return obj == value</pre></div>
<div class="cov"><span class="num"><pre>506</pre></span><pre>        if hasattr(obj, '__contains__'):</pre></div>
<div class="cov"><span class="num"><pre>507</pre></span><pre>            if value in obj:</pre></div>
<div class="cov"><span class="num"><pre>508</pre></span><pre>                return True</pre></div>
<div class="cov"><span class="num"><pre>509</pre></span><pre>        if hasattr(obj, '__iter__'):</pre></div>
<div class="cov"><span class="num"><pre>510</pre></span><pre>            for inner in obj:</pre></div>
<div class="cov"><span class="num"><pre>511</pre></span><pre>                if self.str_compare(inner, value):</pre></div>
<div class="nocov"><span class="num"><pre>512</pre></span><pre>                    return True</pre></div>
<div class="cov"><span class="num"><pre>513</pre></span><pre>        return self.str_compare(obj, value)</pre></div>
<div class="skip"><span class="num"><pre>514</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre>515</pre></span><pre>    def write_marker(self, marker):</pre></div>
<div class="cov"><span class="num"><pre>516</pre></span><pre>        self._content.append((marker,))</pre></div>
<div class="skip"><span class="num"><pre>517</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre>518</pre></span><pre>    def insert_at_marker(self, marker, text):</pre></div>
<div class="cov"><span class="num"><pre>519</pre></span><pre>        for i, item in enumerate(self._content):</pre></div>
<div class="cov"><span class="num"><pre>520</pre></span><pre>            if item == (marker,):</pre></div>
<div class="cov"><span class="num"><pre>521</pre></span><pre>                self._content.insert(i, text)</pre></div>
<div class="cov"><span class="num"><pre>522</pre></span><pre>                break</pre></div>
<div class="nocov"><span class="num"><pre>523</pre></span><pre>        else:</pre></div>
<div class="nocov"><span class="num"><pre>524</pre></span><pre>            self._content.insert(0, text)</pre></div>
<div class="skip"><span class="num"><pre>525</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre>526</pre></span><pre># This can potentially be extended globally</pre></div>
<div class="nocov"><span class="num"><pre>527</pre></span><pre>default_formatter_dict = {'default': default_formatter,</pre></div>
<div class="nocov"><span class="num"><pre>528</pre></span><pre>                          'none': none_formatter,</pre></div>
<div class="nocov"><span class="num"><pre>529</pre></span><pre>                          'escape': escape_formatter,</pre></div>
<div class="nocov"><span class="num"><pre>530</pre></span><pre>                          'escapenl': escapenl_formatter,</pre></div>
<div class="nocov"><span class="num"><pre>531</pre></span><pre>                          'ignore': ignore_formatter,</pre></div>
<div class="nocov"><span class="num"><pre>532</pre></span><pre>                          }</pre></div>
<div class="skip"><span class="num"><pre>533</pre></span><pre></pre></div>
</div>
</body>
</html>
